<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Write and run unit tests - TiDB Development Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">TiDB Development Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/pingcap/tidb-dev-guide" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="write-and-run-unit-tests"><a class="header" href="#write-and-run-unit-tests">Write and run unit tests</a></h1>
<p>The Golang testing framework provides several functionalities and conventions that help structure and execute tests efficiently. To enhance its assertion and mocking capabilities, we use the <a href="https://github.com/stretchr/testify"><code>testify</code></a> library.</p>
<blockquote>
<p>You may find tests using <a href="http://github.com/pingcap/check">pingcap/check</a> which is a fork of <a href="https://github.com/go-check/check">go-check/check</a> in release branches before <code>release-6.1</code>, but since that framework is poorly maintained, we are migrated to testify from <code>release-6.1</code>.
You can check the background and progress on the migration <a href="https://github.com/pingcap/tidb/issues/26022">tracking issue</a>.</p>
</blockquote>
<h2 id="how-to-write-unit-tests"><a class="header" href="#how-to-write-unit-tests">How to write unit tests</a></h2>
<p>We use testify to write unit tests. Basically, it is out-of-the-box <a href="https://pkg.go.dev/testing">testing</a> with testify assertions.</p>
<h3 id="testmain"><a class="header" href="#testmain">TestMain</a></h3>
<p>When you run tests, Golang compiles each package along with any files with names with suffix <code>_test.go</code>. Thus, a test binary contains tests in a package.</p>
<p>Golang testing provides a mechanism to support doing extra setup or teardown before or after testing by writing a package level unique function:</p>
<pre><code class="language-go">func TestMain(m *testing.M)
</code></pre>
<p>After all tests finish, we leverage the function to detect Goroutine leaks by <a href="https://github.com/uber-go/goleak">goleak</a>.</p>
<p>Before you write any unit tests in a package, create a file named <code>main_test.go</code> and setup the scaffolding:</p>
<pre><code class="language-go">func TestMain(m *testing.M) {
    goleak.VerifyTestMain(m)
}
</code></pre>
<p>You can also put global variables or helper functions of the test binary in this file.</p>
<h3 id="assertion"><a class="header" href="#assertion">Assertion</a></h3>
<p>Let's write a basic test for the utility function <code>StrLenOfUint64Fast</code>:</p>
<pre><code class="language-go">func TestStrLenOfUint64Fast(t *testing.T) {
    for i := 0; i &lt; 1000000; i++ {
        num := rand.Uint64()
        expected := len(strconv.FormatUint(num, 10))
        actual := StrLenOfUint64Fast(num)
        require.Equal(t, expected, actual)
    }
}
</code></pre>
<p>Golang testing detects test functions from <code>*_test.go</code> files of the form:</p>
<pre><code class="language-go">func TestXxx(*testing.T)
</code></pre>
<p>where <code>Xxx</code> does not start with a lowercase letter. The function name identifies the test routine.</p>
<p>We follow this pattern but use testify assertions instead of out-of-the-box methods, like <code>Error</code> or <code>Fail</code>, since they are too low level to use.</p>
<p>We mostly use <code>require.Xxx</code> for assertions, which is imported from <code>github.com/stretchr/testify/require</code>. If the assertions fail, the test fails immediately, and we tend to fail tests fast.</p>
<p>Below are the most frequently used assertions:</p>
<pre><code class="language-go">func Equal(t TestingT, expected interface{}, actual interface{}, msgAndArgs ...interface{})
func EqualValues(t TestingT, expected interface{}, actual interface{}, msgAndArgs ...interface{})
func Len(t TestingT, object interface{}, length int, msgAndArgs ...interface{})
func Nil(t TestingT, object interface{}, msgAndArgs ...interface{})
func NoError(t TestingT, err error, msgAndArgs ...interface{})
func NotNil(t TestingT, object interface{}, msgAndArgs ...interface{})
func True(t TestingT, value bool, msgAndArgs ...interface{})
</code></pre>
<p>You can find other assertions follow the <a href="https://pkg.go.dev/github.com/stretchr/testify/require">documentation</a>.</p>
<h3 id="parallel"><a class="header" href="#parallel">Parallel</a></h3>
<p>Golang testing provides a method of <code>testing.T</code> to run tests in parallel:</p>
<pre><code class="language-go">t.Parallel()
</code></pre>
<p>We leverage this function to run tests as parallel as possible, so that we make full use of the available resource.</p>
<p>When some tests should be run in serial, use Golang testing <a href="https://pkg.go.dev/testing#hdr-Subtests_and_Sub_benchmarks">subtests</a> and parallel the parent test only. In this way, tests in the same subtests set run in serial.</p>
<pre><code class="language-go">func TestParent(t *testing.T) {
    t.Parallel()
    // &lt;setup code&gt;
    t.Run("Serial 0", func(t *testing.T) { ... })
    t.Run("Serial 1", func(t *testing.T) { ... })
    t.Run("Serial 2", func(t *testing.T) { ... })
    // &lt;tear-down code&gt;
}
</code></pre>
<p>Generally, if a test modifies global configs or fail points, it should be run in serial.</p>
<p>When writing parallel tests, there are several common considerations.</p>
<p>In Golang, the loop iterator variable is a single variable that takes different value in each loop iteration. Thus, when you run this code it is highly possible to see the last element used for every iteration. You may use below paradigm to work around.</p>
<pre><code class="language-go">func TestParallelWithRange(t *testing.T) {
    for _, test := range tests {
        // copy iterator variable into a new variable, see issue #27779 in tidb repo
        test := test
        t.Run(test.Name, func(t *testing.T) {
            t.Parallel()
            ...
        })
    }
}
</code></pre>
<h3 id="test-kits"><a class="header" href="#test-kits">Test kits</a></h3>
<p>Most of our tests are much more complex than what we describe above. For example, to set up a test, we may create a mock storage, a mock session, or even a local database instance.</p>
<p>These functions are known as test kits. Some are used in one package so we implement them in place; others are quite common so we move it to the <code>testkit</code> directory.</p>
<p>When you write complex unit tests, you may take a look at what test kits we have now and try to leverage them. If we donâ€™t have a test kit for your issue and your issue is considered common, add one.</p>
<h2 id="how-to-run-unit-tests"><a class="header" href="#how-to-run-unit-tests">How to run unit tests</a></h2>
<h3 id="running-all-tests"><a class="header" href="#running-all-tests">Running all tests</a></h3>
<p>You can always run all tests by executing the <code>ut</code> (stands for <strong>unit test</strong>) target in Makefile:</p>
<pre><code class="language-sh">make ut
</code></pre>
<p>This is almost equivalent to <code>go test ./...</code> but it enables and disables fail points before and after running tests.</p>
<p><a href="https://github.com/pingcap/failpoint">pingcap/failpoint</a> is an implementation of <a href="https://www.freebsd.org/cgi/man.cgi?query=fail">failpoints</a> for Golang. A fail point is used to add code points where you can inject errors. Fail point is a code snippet that is only executed when the corresponding fail point is active.</p>
<h3 id="running-a-single-test"><a class="header" href="#running-a-single-test">Running a single test</a></h3>
<p>To run a single test, you can manually repeat what <code>make ut</code> does and narrow the scope in one test or one package:</p>
<pre><code class="language-sh">make failpoint-enable
cd pkg/domain
go test -v -run TestSchemaValidator # or with any other test flags
cd ../..
make failpoint-disable
</code></pre>
<p>or if it is an older test not using testify</p>
<pre><code class="language-sh">make failpoint-enable
(cd pkg/planner/core ; go test -v -run "^TestT$" -check.f TestBinaryOpFunction )
make failpoint-disable
</code></pre>
<p>If one want to compile the test into a debug binary for running in a debugger, one can also use <code>go test -gcflags="all=-N -l" -o ./t</code>, which removes any optimisations and outputs a <code>t</code> binary file ready to be used, like <code>dlv exec ./t</code> or combine it with the above to only debug a single test <code>dlv exec ./t -- -test.run "^TestT$" -check.f TestBinaryOpFunction</code>.</p>
<p>Notice there is also an <code>ut</code> utility for running tests, see <code>Makefile</code> and <code>tools/bin/ut</code>.</p>
<p>To display information on all the test flags, enter <code>go help testflag</code>.</p>
<p>If you develop with GoLand, you can also run a test from the IDE with manually enabled and disabled fail points. See the <a href="https://www.jetbrains.com/help/go/performing-tests.html">documentation</a> for details.</p>
<p><img src="../img/goland-run-tests.png" alt="GoLand Run Tests" /></p>
<p>As shown above, you can run tests of the whole package, of a test, or of a subtest, by click the corresponding gutter icon.</p>
<p>If you develop with VS Code, you can also run a test from the editor with manually enabled and disabled fail points. See the <a href="https://code.visualstudio.com/docs/languages/go#_test">documentation</a> for details.</p>
<p><img src="../img/vscode-run-tests.png" alt="VS Code Run Tests" /></p>
<p>As shown above, you can run tests of the whole package, of a test, or of a file.</p>
<h3 id="running-tests-for-a-pull-request"><a class="header" href="#running-tests-for-a-pull-request">Running tests for a pull request</a></h3>
<blockquote>
<p>If you haven't joined the organization, you should wait for a member to comment with <code>/ok-to-test</code> to your pull request.</p>
</blockquote>
<p>Before you merge a pull request, it must pass all tests.</p>
<p>Generally, continuous integration (CI) runs the tests for you; however, if you want to run tests with conditions or rerun tests on failure, you should know how to do that, the rerun guide comment will be sent when the CI tests failed.</p>
<h4 id="retest"><a class="header" href="#retest"><code>/retest</code></a></h4>
<p>Rerun all failed CI test cases.</p>
<h4 id="test-test1-testn"><a class="header" href="#test-test1-testn"><code>/test {{test1}} {{testN}}</code></a></h4>
<p>Run given CI failed tests.</p>
<h4 id="ci-parameters"><a class="header" href="#ci-parameters">CI parameters</a></h4>
<p>CI jobs accepts the following parameters passed from <strong>pull request title</strong>:</p>
<p>format: <code>&lt;origin pr title&gt; | &lt;the CI args pairs&gt;</code></p>
<p>CI args pairs:</p>
<ul>
<li><code>tikv=&lt;branch&gt;|&lt;pr/$num&gt;</code> specifies which tikv to use.</li>
<li><code>pd=&lt;branch&gt;|&lt;pr/$num&gt;</code> specifies which pd to use.</li>
<li><code>tidb-test=&lt;branch&gt;|&lt;pr/$num&gt;</code> specifies which tidb-test to use.</li>
</ul>
<p>For example:</p>
<pre><code>pkg1: support xxx feature | tidb-test=pr/1234
pkg2: support yyy feature | tidb-test=release-6.5 tikv=pr/999
</code></pre>
<h2 id="how-to-find-failed-tests"><a class="header" href="#how-to-find-failed-tests">How to find failed tests</a></h2>
<p>There are several common causes of failed tests.</p>
<h3 id="assertion-failed"><a class="header" href="#assertion-failed">Assertion failed</a></h3>
<p>The most common cause of failed tests is that assertion failed. Its failure report looks like:</p>
<pre><code>=== RUN   TestTopology
    info_test.go:72: 
            Error Trace:    info_test.go:72
            Error:          Not equal: 
                            expected: 1282967700000
                            actual  : 1628585893
            Test:           TestTopology
--- FAIL: TestTopology (0.76s)
</code></pre>
<p>To find this type of failure, enter <code>grep -i "FAIL"</code> to search the report output.</p>
<h3 id="data-race"><a class="header" href="#data-race">Data race</a></h3>
<p>Golang testing supports detecting data race by running tests with the <code>-race</code> flag. Its failure report looks like:</p>
<pre><code>[2021-06-21T15:36:38.766Z] ==================
[2021-06-21T15:36:38.766Z] WARNING: DATA RACE
[2021-06-21T15:36:38.766Z] Read at 0x00c0055ce380 by goroutine 108:
...
[2021-06-21T15:36:38.766Z] Previous write at 0x00c0055ce380 by goroutine 169:
[2021-06-21T15:36:38.766Z]   [failed to restore the stack]
</code></pre>
<h3 id="goroutine-leak"><a class="header" href="#goroutine-leak">Goroutine leak</a></h3>
<p>We use goleak to detect goroutine leak for tests. Its failure report looks like:</p>
<pre><code>goleak: Errors on successful test run: found unexpected goroutines:
[Goroutine 104 in state chan receive, with go.etcd.io/etcd/pkg/logutil.(*MergeLogger).outputLoop on top of the stack:
goroutine 104 [chan receive]:
go.etcd.io/etcd/pkg/logutil.(*MergeLogger).outputLoop(0xc000197398)
    /go/pkg/mod/go.etcd.io/etcd@v0.5.0-alpha.5.0.20200824191128-ae9734ed278b/pkg/logutil/merge_logger.go:173 +0x3ac
created by go.etcd.io/etcd/pkg/logutil.NewMergeLogger
    /go/pkg/mod/go.etcd.io/etcd@v0.5.0-alpha.5.0.20200824191128-ae9734ed278b/pkg/logutil/merge_logger.go:91 +0x85

</code></pre>
<p>To  determine the source of package leaks, see the <a href="https://github.com/uber-go/goleak/#determine-source-of-package-leaks">documentation</a></p>
<h3 id="timeout"><a class="header" href="#timeout">Timeout</a></h3>
<p>After @tiancaiamao introduced the timeout checker for continuous integration, every test case should run in at most five seconds.</p>
<p>If a test case takes longer, its failure report looks like:</p>
<pre><code>[2021-08-09T03:33:57.661Z] The following test cases take too long to finish:
[2021-08-09T03:33:57.661Z] PASS: tidb_test.go:874: tidbTestSerialSuite.TestTLS  7.388s
[2021-08-09T03:33:57.661Z] --- PASS: TestCluster (5.20s)
</code></pre>
<p>And for integration tests, please refer to <a href="./run-and-debug-integration-tests.html">Run and debug integration tests</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../get-started/setup-an-ide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../get-started/debug-and-profile.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../get-started/setup-an-ide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../get-started/debug-and-profile.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
