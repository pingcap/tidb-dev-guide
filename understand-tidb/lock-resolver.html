<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Lock Resolver - TiDB Development Guide</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">TiDB Development Guide</a></li><li class="chapter-item expanded "><a href="../get-started/introduction.html"><strong aria-hidden="true">1.</strong> Get Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../get-started/install-golang.html"><strong aria-hidden="true">1.1.</strong> Install Golang</a></li><li class="chapter-item expanded "><a href="../get-started/build-tidb-from-source.html"><strong aria-hidden="true">1.2.</strong> Get the code, build and run</a></li><li class="chapter-item expanded "><a href="../get-started/setup-an-ide.html"><strong aria-hidden="true">1.3.</strong> Setup an IDE</a></li><li class="chapter-item expanded "><a href="../get-started/write-and-run-unit-tests.html"><strong aria-hidden="true">1.4.</strong> Write and run unit tests</a></li><li class="chapter-item expanded "><a href="../get-started/debug-and-profile.html"><strong aria-hidden="true">1.5.</strong> Debug and profile</a></li><li class="chapter-item expanded "><a href="../get-started/commit-code-and-submit-a-pull-request.html"><strong aria-hidden="true">1.6.</strong> Commit code and submit a pull request</a></li></ol></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/introduction.html"><strong aria-hidden="true">2.</strong> Contribute to TiDB</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contribute-to-tidb/community-guideline.html"><strong aria-hidden="true">2.1.</strong> Community Guideline</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/report-an-issue.html"><strong aria-hidden="true">2.2.</strong> Report an Issue</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/issue-triage.html"><strong aria-hidden="true">2.3.</strong> Issue Triage</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/contribute-code.html"><strong aria-hidden="true">2.4.</strong> Contribute Code</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/cherrypick-a-pr.html"><strong aria-hidden="true">2.5.</strong> Cherry-pick a Pull Request</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/review-a-pr.html"><strong aria-hidden="true">2.6.</strong> Review a Pull Request</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/make-a-proposal.html"><strong aria-hidden="true">2.7.</strong> Make a Proposal</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/code-style-and-quality-guide.html"><strong aria-hidden="true">2.8.</strong> Code Style and Quality Guide</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/write-document.html"><strong aria-hidden="true">2.9.</strong> Write Document</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/release-notes-style-guide.html"><strong aria-hidden="true">2.10.</strong> Release Notes Language Style Guide</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/committer-guide.html"><strong aria-hidden="true">2.11.</strong> Committer Guide</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/miscellaneous-topics.html"><strong aria-hidden="true">2.12.</strong> Miscellaneous Topics</a></li></ol></li><li class="chapter-item expanded "><a href="../understand-tidb/introduction.html"><strong aria-hidden="true">3.</strong> Understand TiDB</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../understand-tidb/the-lifecycle-of-a-statement.html"><strong aria-hidden="true">3.1.</strong> The Lifecycle of a Statement</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../understand-tidb/ddl.html"><strong aria-hidden="true">3.1.1.</strong> DDL</a></li><li class="chapter-item expanded "><a href="../understand-tidb/dml.html"><strong aria-hidden="true">3.1.2.</strong> DML</a></li><li class="chapter-item expanded "><a href="../understand-tidb/dql.html"><strong aria-hidden="true">3.1.3.</strong> DQL</a></li></ol></li><li class="chapter-item expanded "><a href="../understand-tidb/parser.html"><strong aria-hidden="true">3.2.</strong> Parser</a></li><li class="chapter-item expanded "><a href="../understand-tidb/planner.html"><strong aria-hidden="true">3.3.</strong> Planner</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../understand-tidb/table-statistics.html"><strong aria-hidden="true">3.3.1.</strong> Table Statistics</a></li><li class="chapter-item expanded "><a href="../understand-tidb/rbo.html"><strong aria-hidden="true">3.3.2.</strong> Rule-based Optimization</a></li><li class="chapter-item expanded "><a href="../understand-tidb/cbo.html"><strong aria-hidden="true">3.3.3.</strong> Cost-based Optimization</a></li><li class="chapter-item expanded "><a href="../understand-tidb/plan-cache.html"><strong aria-hidden="true">3.3.4.</strong> Plan Cache</a></li><li class="chapter-item expanded "><a href="../understand-tidb/sql-plan-management.html"><strong aria-hidden="true">3.3.5.</strong> SQL Plan Management</a></li></ol></li><li class="chapter-item expanded "><a href="../understand-tidb/execution.html"><strong aria-hidden="true">3.4.</strong> Execution</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../understand-tidb/parallel-execution-framework.html"><strong aria-hidden="true">3.4.1.</strong> Parallel Execution Framework</a></li><li class="chapter-item expanded "><a href="../understand-tidb/implementation-of-vectorized-execution.html"><strong aria-hidden="true">3.4.2.</strong> Implementation of Vectorized Execution</a></li><li class="chapter-item expanded "><a href="../understand-tidb/memory-management-mechanism.html"><strong aria-hidden="true">3.4.3.</strong> Memory Management Mechanism</a></li><li class="chapter-item expanded "><a href="../understand-tidb/implementation-of-typical-operators.html"><strong aria-hidden="true">3.4.4.</strong> Implementation of Typical Operators</a></li></ol></li><li class="chapter-item expanded "><a href="../understand-tidb/transaction.html"><strong aria-hidden="true">3.5.</strong> Transaction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../understand-tidb/transaction-on-tikv.html"><strong aria-hidden="true">3.5.1.</strong> Transaction on TiKV</a></li><li class="chapter-item expanded "><a href="../understand-tidb/optimistic-transaction.html"><strong aria-hidden="true">3.5.2.</strong> Optimistic Transaction</a></li><li class="chapter-item expanded "><a href="../understand-tidb/lock-resolver.html" class="active"><strong aria-hidden="true">3.5.3.</strong> Lock Resolver</a></li><li class="chapter-item expanded "><a href="../understand-tidb/pessimistic-transaction.html"><strong aria-hidden="true">3.5.4.</strong> Pessimistic Transaction</a></li><li class="chapter-item expanded "><a href="../understand-tidb/async-commit.html"><strong aria-hidden="true">3.5.5.</strong> Async Commit</a></li><li class="chapter-item expanded "><a href="../understand-tidb/1pc.html"><strong aria-hidden="true">3.5.6.</strong> 1PC</a></li><li class="chapter-item expanded "><a href="../understand-tidb/mvcc-garbage-collection.html"><strong aria-hidden="true">3.5.7.</strong> MVCC garbage collection</a></li></ol></li><li class="chapter-item expanded "><a href="../understand-tidb/session.html"><strong aria-hidden="true">3.6.</strong> Session</a></li><li class="chapter-item expanded "><a href="../understand-tidb/privilege.html"><strong aria-hidden="true">3.7.</strong> Privilege</a></li><li class="chapter-item expanded "><a href="../understand-tidb/plugin.html"><strong aria-hidden="true">3.8.</strong> Plugin</a></li></ol></li><li class="chapter-item expanded "><a href="../project-management/introduction.html"><strong aria-hidden="true">4.</strong> Project Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../project-management/release-train-model.html"><strong aria-hidden="true">4.1.</strong> Releases Train Model</a></li><li class="chapter-item expanded "><a href="../project-management/tidb-versioning.html"><strong aria-hidden="true">4.2.</strong> TiDB Versioning</a></li></ol></li><li class="chapter-item expanded "><a href="../extending-tidb/introduction.html"><strong aria-hidden="true">5.</strong> Extending TiDB</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../extending-tidb/add-a-function.html"><strong aria-hidden="true">5.1.</strong> Add a function</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">TiDB Development Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/pingcap/tidb-dev-guide" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="lock-resolver"><a class="header" href="#lock-resolver">Lock Resolver</a></h1>
<p>As we described in <a href="./transaction.html">other sections</a>, TiDB's transaction system is based on Google's <a href="https://tikv.org/deep-dive/distributed-transaction/percolator/">Percolator</a> algorithm. Which makes it necessary to resolve locks when a reading transaction meets locked keys or during <a href="./mvcc-garbage-collection.html">GC</a>.</p>
<p>So we introduced Lock Resolver in TiDB to resolve locks.</p>
<h2 id="the-data-structure"><a class="header" href="#the-data-structure">The Data Structure</a></h2>
<p>Lock Resolver is a quiet simple struct: </p>
<pre><code class="language-go">type LockResolver struct {
	store storage
	mu    struct {
		sync.RWMutex
		// resolved caches resolved txns (FIFO, txn id -&gt; txnStatus).
		resolved       map[uint64]TxnStatus
		recentResolved *list.List
	}
}
</code></pre>
<p>The <code>store</code> field is used to send requests to a region on TiKV.
And the fields inside the <code>mu</code> are used to cache the resolved transactions' status, which is used to speed up the transaction status checking.</p>
<h2 id="lock-resolving-process"><a class="header" href="#lock-resolving-process">Lock Resolving process</a></h2>
<p>Now let's see the real important part: the lock resolving process.</p>
<p>Basically, the resolving process is in 2 steps:</p>
<ol>
<li>For each lock, get the commit status of the corresponding transaction.</li>
<li>Send <code>ResolveLock</code> cmd to tell the storage layer to do the resolve work.</li>
</ol>
<p>In the following several paragraphs, we will give you some brief introduction about each step.</p>
<p>If you want to read all of the code, <a href="https://github.com/tikv/client-go/blob/cef46d13cc007387e814f231d9e7ec0b4cc1bfaf/txnkv/txnlock/lock_resolver.go#L303"><code>LockResolver.resolveLocks</code></a> is a good place to start.</p>
<h3 id="get-transaction-status-for-a-lock"><a class="header" href="#get-transaction-status-for-a-lock">Get transaction status for a lock</a></h3>
<h4 id="tidb-part"><a class="header" href="#tidb-part">TiDB part</a></h4>
<p>Related code is <a href="https://github.com/tikv/client-go/blob/cef46d13cc007387e814f231d9e7ec0b4cc1bfaf/txnkv/txnlock/lock_resolver.go#L452"><code>LockResolver.getTxnStatusFromLock</code></a> and <a href="https://github.com/tikv/client-go/blob/cef46d13cc007387e814f231d9e7ec0b4cc1bfaf/txnkv/txnlock/lock_resolver.go#L526"><code>LockResolver.getTxnStatus</code></a>.</p>
<p><a href="https://github.com/tikv/client-go/blob/cef46d13cc007387e814f231d9e7ec0b4cc1bfaf/txnkv/txnlock/lock_resolver.go#L526"><code>LockResolver.getTxnStatus</code></a> just assemble a <code>CheckTxnStatus</code> request and send it to the TiKV the primary key is located on. TiKV will return a <a href="https://tikv.github.io/doc/tikv/storage/enum.TxnStatus.html"><code>TxnStatus</code></a>, which represents the status of a transaction, like <code>RolledBack</code>(the transaction has already been rolled back before), <code>TtlExpire</code>(the transaction's is expired, TiKV just rolled it back), <code>Committed</code>(the transaction was committed successfully before), etc. to TiDB.</p>
<p><a href="https://github.com/tikv/client-go/blob/cef46d13cc007387e814f231d9e7ec0b4cc1bfaf/txnkv/txnlock/lock_resolver.go#L452"><code>LockResolver.getTxnStatusFromLock</code></a> basically delegate its work to <a href="https://github.com/tikv/client-go/blob/cef46d13cc007387e814f231d9e7ec0b4cc1bfaf/txnkv/txnlock/lock_resolver.go#L526"><code>LockResolver.getTxnStatus</code></a> with the information in the lock and add some retry and error handling logic.</p>
<h4 id="tikv-part"><a class="header" href="#tikv-part">TiKV part</a></h4>
<p>As we showed above, we use a <a href="https://tikv.github.io/doc/tikv/storage/txn/commands/struct.CheckTxnStatus.html"><code>CheckTxnStatus</code></a> request to get the status of a transaction when resolving a lock.</p>
<p>The major processing logic can be found <a href="https://github.com/tikv/tikv/blob/86d80e98927fb372536bcb52937c421ebf78c8b2/src/storage/txn/commands/check_txn_status.rs#L67"><code>here</code></a>, this function is a little complex (mainly because the scheduling process in TiKV), I'll show you the basic idea with some simplified pseudo code with detailed comments, before that, there are several optimizations and related concepts we should know:</p>
<h5 id="collapse-continuous-rollbacks-tikv3290"><a class="header" href="#collapse-continuous-rollbacks-tikv3290">collapse continuous rollbacks (<a href="https://github.com/tikv/tikv/pull/3290">tikv#3290</a>)</a></h5>
<p>Instead of keeping all rollbacks in write column family when a key rollbacked for several times, this PR collapse continuous rollbacks, and only keep the latest rollback.</p>
<h5 id="protect-primary-locks-tikv5575"><a class="header" href="#protect-primary-locks-tikv5575">protect primary locks (<a href="https://github.com/tikv/tikv/pull/5575">tikv#5575</a>)</a></h5>
<p>After we have pessimistic lock in TiKV, if the rollback record of the primary lock is collapsed and TiKV receives stale acquire_pessimistic_lock and prewrite, the transaction will commit successfully even if secondary locks are rolled back. To solve this problem, we can prevent the rollback records of the primary key of pessimistic transactions from being collapsed. By setting the short value of these rollback records to &quot;protected&quot;.</p>
<h5 id="gc_fence-tikv9207"><a class="header" href="#gc_fence-tikv9207">gc_fence (<a href="https://github.com/tikv/tikv/pull/9207">tikv#9207</a>)</a></h5>
<p>See the super detailed comment <a href="https://github.com/tikv/tikv/blob/a345ff7f835b49c9addf4883b339ce268e1668cc/components/txn_types/src/write.rs#L77">here</a>.</p>
<p>After understand these, you can finally understand the code:</p>
<pre><code>fn process_write(self, snapshot: Snapshot, context: WriteContext) {
	// async commit related stuff, see async commit doc
	context.concurrency_manager.update_max_ts();

	let lock = load_lock_on(self.primary_key);

	let (txn_status, released) = if let Some(lock) = lock &amp;&amp; lock.ts == self.lock_ts {
		// the lock still exists, ie. the transaction is still alive
		check_txn_status_lock_exists();
	} else {
		// the lock is missing
		check_txn_status_missing_lock();
	}

	if let TxnStatus::TtlExpire = txn_status {
        context.lock_mgr.notify_released(released);
    }

	// return result to user
	return txn_status;
}
</code></pre>
<pre><code>fn check_txn_status_lock_exists(
	primary_key: Key,
	lock: Lock,
) {
	if use_async_commit {
		return (TxnStatus::Uncommitted, None)
	}
	let lock_expired = lock.ts.physical() + lock.ttl &lt; current_ts.physical()
	if lock_expired {
		if resolving_pessimistic_lock &amp;&amp; lock.lock_type == LockType::Pessimistic {
			// unlock_key just delete `primary_key` in lockCF
            let released = unlock_key(primary_key);
            return (TxnStatus::PessimisticRollBack, released);
        } else {
			// rollback_lock is complex, see below
            let released = rollback_lock(lock);
            return (TxnStatus::TtlExpire, released);
        }
	}
	return (TxnStatus::Uncommitted, None)
}
</code></pre>
<pre><code>pub fn rollback_lock() {
	// get transaction commit record on `key`
	let commit_record = get_txn_commit_record(key);
    let overlapped_write = match commit_record {
		// The commit record of the given transaction is not found. 
		// But it's possible that there's another transaction's commit record, whose `commit_ts` equals to the current transaction's `start_ts`. That kind of record will be returned via the `overlapped_write` field.
    	// In this case, if the current transaction is to be rolled back, the `overlapped_write` must not be overwritten.
        TxnCommitRecord::None { overlapped_write } =&gt; overlapped_write,
        TxnCommitRecord::SingleRecord { write, .. } if write.write_type != WriteType::Rollback =&gt; {
            panic!(&quot;txn record found but not expected: {:?}&quot;, txn)
        }
        _ =&gt; return txn.unlock_key(key, is_pessimistic_txn),
    };

    // If prewrite type is DEL or LOCK or PESSIMISTIC, it is no need to delete value.
    if lock.short_value.is_none() &amp;&amp; lock.lock_type == LockType::Put {
        delete_value(key, lock.ts);
    }

	// if this is primary key of a pessimistic transaction, we need to protect the rollback just as we mentioned above
	let protect = is_pessimistic_txn &amp;&amp; key.is_encoded_from(&amp;lock.primary);
	put_rollback_record(key, protect);
	collapse_prev_rollback(key);
    return unlock_key(key, is_pessimistic_txn);
}
</code></pre>
<pre><code>pub fn check_txn_status_missing_lock() {
    match get_txn_commit_record(primary_key) {
        TxnCommitRecord::SingleRecord { commit_ts, write } =&gt; {
            if write.write_type == WriteType::Rollback {
                Ok(TxnStatus::RolledBack)
            } else {
                Ok(TxnStatus::committed(commit_ts))
            }
        }
        TxnCommitRecord::OverlappedRollback { .. } =&gt; Ok(TxnStatus::RolledBack),
        TxnCommitRecord::None { overlapped_write } =&gt; {
            if MissingLockAction::ReturnError == action {
                return Err(TxnNotFound);
            }
            if resolving_pessimistic_lock {
                return Ok(TxnStatus::LockNotExistDoNothing);
            }

            let ts = reader.start_ts;

            if action == MissingLockAction::Rollback {
                collapse_prev_rollback(txn, reader, &amp;primary_key)?;
            }

            if let (Some(l), None) = (mismatch_lock, overlapped_write.as_ref()) {
				// When putting rollback record on a key that's locked by another transaction, the second transaction may overwrite the current rollback record when it's committed. Sometimes it may break consistency. 
				// To solve the problem, add the timestamp of the current rollback to the lock. So when the lock is committed, it can check if it will overwrite a rollback record by checking the information in the lock.
                mark_rollback_on_mismatching_lock(
                    &amp;primary_key,
                    l,
                    action == MissingLockAction::ProtectedRollback,
                );
            }

            // Insert a Rollback to Write CF in case that a stale prewrite
            // command is received after a cleanup command.
			put_rollback_record(primary_key, action == MissingLockAction::ProtectedRollback);

            Ok(TxnStatus::LockNotExist)
        }
    }
}
</code></pre>
<h3 id="resolve"><a class="header" href="#resolve">Resolve</a></h3>
<h4 id="tidb-part-1"><a class="header" href="#tidb-part-1">TiDB Part</a></h4>
<p>After we get the transaction status with <a href="https://github.com/tikv/client-go/blob/cef46d13cc007387e814f231d9e7ec0b4cc1bfaf/txnkv/txnlock/lock_resolver.go#L452"><code>LockResolver.getTxnStatusFromLock</code></a> <a href="https://github.com/tikv/client-go/blob/cef46d13cc007387e814f231d9e7ec0b4cc1bfaf/txnkv/txnlock/lock_resolver.go#L330">here</a>, if the transaction has been expired (either committed or rollbacked), we need to resolve the lock.</p>
<p>There are three different kinds of locks we need to pay attention to when doing the resolving work:</p>
<ul>
<li>locks created by <a href="./async-commit.html">async commit</a> transactions
This kind of lock will be resolved by <a href="https://github.com/tikv/client-go/blob/cef46d13cc007387e814f231d9e7ec0b4cc1bfaf/txnkv/txnlock/lock_resolver.go#L738"><code>resolveLockAsync</code> function</a>, you can refer to <a href="./async-commit.html">Transaction recovery chapter in <em>async commit</em></a> for more information.</li>
<li>pessimistic locks created by <a href="./pessimistic-transaction.html">pessimistic transaction</a>
This kind of lock will be resolved by <a href="https://github.com/tikv/client-go/blob/cef46d13cc007387e814f231d9e7ec0b4cc1bfaf/txnkv/txnlock/lock_resolver.go#L933"><code>resolvePessimisticLock</code> function</a>, which just send <a href="https://tikv.github.io/doc/kvproto/kvrpcpb/struct.PessimisticRollbackRequest.html"><code>PessimisticRollbackRequest</code></a> to TiKV, with some retry and error handling logic.</li>
<li>optimistic locks created by <a href="./optimistic-transaction.html">optimistic transaction</a>
This kind of lock will be resolved by <a href="https://github.com/tikv/client-go/blob/cef46d13cc007387e814f231d9e7ec0b4cc1bfaf/txnkv/txnlock/lock_resolver.go#L874"><code>resolveLock</code> function</a>, which just send <a href="https://tikv.github.io/doc/kvproto/kvrpcpb/struct.ResolveLockRequest.html"><code>ResolveLockRequest</code></a> to TiKV, with some retry and error handling logic.</li>
</ul>
<h4 id="tikv-part-1"><a class="header" href="#tikv-part-1">TiKV Part</a></h4>
<p>When a resolve lock request reaches TiKV, depends on whether <code>resolve_keys</code> field is empty or not, TiKV will do different things:</p>
<h5 id="resolvelockreadphase--resolvelock"><a class="header" href="#resolvelockreadphase--resolvelock">ResolveLockReadPhase + ResolveLock</a></h5>
<p>This will triggered when <code>resolve_keys</code> field is not set.</p>
<p><code>ResolveLockReadPhase</code> will scan keys and locks on them which should be resolved in a region, to prevent huge writes, we'll do the scan in batches (<code>RESOLVE_LOCK_BATCH_SIZE</code> keys in a batch).</p>
<p>After each batch is read, a <code>ResolveLock</code> command will be spawned to do the real resolve work.</p>
<p>In <code>ResolveLock</code>, for each key and lock on it, depend on whether the transaction status
is committed or not, we'll cleanup or commit it.</p>
<p>And then, TiKV will wake up the blocked transactions, and we are done.</p>
<h5 id="resolvelocklite"><a class="header" href="#resolvelocklite">ResolveLockLite</a></h5>
<p>This will triggered when <code>resolve_keys</code> field is set.</p>
<p><code>ResolveLockLite</code> is just a simplified version of <code>ResolveLock</code>, which will do the resolve work on <code>resolve_keys</code> on the request.</p>
<h2 id="where-do-we-use-it"><a class="header" href="#where-do-we-use-it">Where do we use it?</a></h2>
<ul>
<li>When <a href="https://github.com/tikv/client-go/blob/9ec50224bea69a1d20d34535db5791f054928501/txnkv/transaction/pessimistic.go#L212">acquiring PessimisticLock</a>,
it is possible that a transaction meet other transaction's lock when it is trying to acquire the lock. In this situation, we should try to resolve the old transaction's lock first.</li>
<li>When reading from TiKV, eg. when <a href="https://github.com/tikv/client-go/blob/9ec50224bea69a1d20d34535db5791f054928501/txnkv/txnsnapshot/scan.go#L283">scanning data</a>, we should resolve the lock we met first.</li>
<li>When doing <a href="https://github.com/tikv/client-go/blob/9ec50224bea69a1d20d34535db5791f054928501/tikv/gc.go#L52">GC</a>, see <a href="./mvcc-garbage-collection.html">the GC chapter</a> for detail.</li>
</ul>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>This document talked about the data structure of Lock Resolver in TiDB, and its working process and usage. You can combine this with other parts of our <a href="./transaction.html">transaction system</a> to have a deeper understanding.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../understand-tidb/optimistic-transaction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../understand-tidb/pessimistic-transaction.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../understand-tidb/optimistic-transaction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../understand-tidb/pessimistic-transaction.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
