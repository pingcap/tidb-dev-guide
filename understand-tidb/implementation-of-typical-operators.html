<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Implementation of Typical Operators - TiDB Development Guide</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">TiDB Development Guide</a></li><li class="chapter-item expanded "><a href="../get-started/introduction.html"><strong aria-hidden="true">1.</strong> Get Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../get-started/install-golang.html"><strong aria-hidden="true">1.1.</strong> Install Golang</a></li><li class="chapter-item expanded "><a href="../get-started/build-tidb-from-source.html"><strong aria-hidden="true">1.2.</strong> Get the code, build and run</a></li><li class="chapter-item expanded "><a href="../get-started/setup-an-ide.html"><strong aria-hidden="true">1.3.</strong> Setup an IDE</a></li><li class="chapter-item expanded "><a href="../get-started/write-and-run-unit-tests.html"><strong aria-hidden="true">1.4.</strong> Write and run unit tests</a></li><li class="chapter-item expanded "><a href="../get-started/debug-and-profile.html"><strong aria-hidden="true">1.5.</strong> Debug and profile</a></li><li class="chapter-item expanded "><a href="../get-started/commit-code-and-submit-a-pull-request.html"><strong aria-hidden="true">1.6.</strong> Commit code and submit a pull request</a></li></ol></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/introduction.html"><strong aria-hidden="true">2.</strong> Contribute to TiDB</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contribute-to-tidb/community-guideline.html"><strong aria-hidden="true">2.1.</strong> Community Guideline</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/report-an-issue.html"><strong aria-hidden="true">2.2.</strong> Report an Issue</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/issue-triage.html"><strong aria-hidden="true">2.3.</strong> Issue Triage</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/contribute-code.html"><strong aria-hidden="true">2.4.</strong> Contribute Code</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/cherrypick-a-pr.html"><strong aria-hidden="true">2.5.</strong> Cherry-pick a Pull Request</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/review-a-pr.html"><strong aria-hidden="true">2.6.</strong> Review a Pull Request</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/make-a-proposal.html"><strong aria-hidden="true">2.7.</strong> Make a Proposal</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/code-style-and-quality-guide.html"><strong aria-hidden="true">2.8.</strong> Code Style and Quality Guide</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/write-document.html"><strong aria-hidden="true">2.9.</strong> Write Document</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/release-notes-style-guide.html"><strong aria-hidden="true">2.10.</strong> Release Notes Language Style Guide</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/committer-guide.html"><strong aria-hidden="true">2.11.</strong> Committer Guide</a></li><li class="chapter-item expanded "><a href="../contribute-to-tidb/miscellaneous-topics.html"><strong aria-hidden="true">2.12.</strong> Miscellaneous Topics</a></li></ol></li><li class="chapter-item expanded "><a href="../understand-tidb/introduction.html"><strong aria-hidden="true">3.</strong> Understand TiDB</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../understand-tidb/the-lifecycle-of-a-statement.html"><strong aria-hidden="true">3.1.</strong> The Lifecycle of a Statement</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../understand-tidb/ddl.html"><strong aria-hidden="true">3.1.1.</strong> DDL</a></li><li class="chapter-item expanded "><a href="../understand-tidb/dml.html"><strong aria-hidden="true">3.1.2.</strong> DML</a></li><li class="chapter-item expanded "><a href="../understand-tidb/dql.html"><strong aria-hidden="true">3.1.3.</strong> DQL</a></li></ol></li><li class="chapter-item expanded "><a href="../understand-tidb/parser.html"><strong aria-hidden="true">3.2.</strong> Parser</a></li><li class="chapter-item expanded "><a href="../understand-tidb/planner.html"><strong aria-hidden="true">3.3.</strong> Planner</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../understand-tidb/table-statistics.html"><strong aria-hidden="true">3.3.1.</strong> Table Statistics</a></li><li class="chapter-item expanded "><a href="../understand-tidb/rbo.html"><strong aria-hidden="true">3.3.2.</strong> Rule-based Optimization</a></li><li class="chapter-item expanded "><a href="../understand-tidb/cbo.html"><strong aria-hidden="true">3.3.3.</strong> Cost-based Optimization</a></li><li class="chapter-item expanded "><a href="../understand-tidb/plan-cache.html"><strong aria-hidden="true">3.3.4.</strong> Plan Cache</a></li><li class="chapter-item expanded "><a href="../understand-tidb/sql-plan-management.html"><strong aria-hidden="true">3.3.5.</strong> SQL Plan Management</a></li></ol></li><li class="chapter-item expanded "><a href="../understand-tidb/execution.html"><strong aria-hidden="true">3.4.</strong> Execution</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../understand-tidb/parallel-execution-framework.html"><strong aria-hidden="true">3.4.1.</strong> Parallel Execution Framework</a></li><li class="chapter-item expanded "><a href="../understand-tidb/implementation-of-vectorized-execution.html"><strong aria-hidden="true">3.4.2.</strong> Implementation of Vectorized Execution</a></li><li class="chapter-item expanded "><a href="../understand-tidb/memory-management-mechanism.html"><strong aria-hidden="true">3.4.3.</strong> Memory Management Mechanism</a></li><li class="chapter-item expanded "><a href="../understand-tidb/implementation-of-typical-operators.html" class="active"><strong aria-hidden="true">3.4.4.</strong> Implementation of Typical Operators</a></li></ol></li><li class="chapter-item expanded "><a href="../understand-tidb/transaction.html"><strong aria-hidden="true">3.5.</strong> Transaction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../understand-tidb/transaction-on-tikv.html"><strong aria-hidden="true">3.5.1.</strong> Transaction on TiKV</a></li><li class="chapter-item expanded "><a href="../understand-tidb/optimistic-transaction.html"><strong aria-hidden="true">3.5.2.</strong> Optimistic Transaction</a></li><li class="chapter-item expanded "><a href="../understand-tidb/lock-resolver.html"><strong aria-hidden="true">3.5.3.</strong> Lock Resolver</a></li><li class="chapter-item expanded "><a href="../understand-tidb/pessimistic-transaction.html"><strong aria-hidden="true">3.5.4.</strong> Pessimistic Transaction</a></li><li class="chapter-item expanded "><a href="../understand-tidb/async-commit.html"><strong aria-hidden="true">3.5.5.</strong> Async Commit</a></li><li class="chapter-item expanded "><a href="../understand-tidb/1pc.html"><strong aria-hidden="true">3.5.6.</strong> 1PC</a></li><li class="chapter-item expanded "><a href="../understand-tidb/mvcc-garbage-collection.html"><strong aria-hidden="true">3.5.7.</strong> MVCC garbage collection</a></li></ol></li><li class="chapter-item expanded "><a href="../understand-tidb/session.html"><strong aria-hidden="true">3.6.</strong> Session</a></li><li class="chapter-item expanded "><a href="../understand-tidb/privilege.html"><strong aria-hidden="true">3.7.</strong> Privilege</a></li><li class="chapter-item expanded "><a href="../understand-tidb/plugin.html"><strong aria-hidden="true">3.8.</strong> Plugin</a></li></ol></li><li class="chapter-item expanded "><a href="../project-management/introduction.html"><strong aria-hidden="true">4.</strong> Project Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../project-management/release-train-model.html"><strong aria-hidden="true">4.1.</strong> Releases Train Model</a></li><li class="chapter-item expanded "><a href="../project-management/tidb-versioning.html"><strong aria-hidden="true">4.2.</strong> TiDB Versioning</a></li></ol></li><li class="chapter-item expanded "><a href="../extending-tidb/introduction.html"><strong aria-hidden="true">5.</strong> Extending TiDB</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../extending-tidb/add-a-function.html"><strong aria-hidden="true">5.1.</strong> Add a function</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">TiDB Development Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/pingcap/tidb-dev-guide" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="implementation-of-typical-operators"><a class="header" href="#implementation-of-typical-operators">Implementation of Typical Operators</a></h1>
<p>This section introduces the implementation details of three typical TiDB operators: Sort, HashAgg, and HashJoin.</p>
<p>Firstly, every operator should implement three basic interfaces of <code>Executor</code>:</p>
<ul>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/internal/exec/executor.go#L50">Open</a> - Initializes the operator, sets up the memory tracker/disk tracker, and other meta-info for the current operator.</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/internal/exec/executor.go#L51">Next</a> - Each call to <code>Next</code> returns a chunk of data. Returning an empty chunk indicates that the execution is complete for the current executor. Note that <code>Next</code> is not thread-safe. It's by design that <code>Next</code> is not called concurrently for all operators.</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/internal/exec/executor.go#L52">Close</a> - Responsible for releasing all resources held by the executor.</li>
</ul>
<h3 id="sort"><a class="header" href="#sort">Sort</a></h3>
<p>The Sort operator is used to arrange the result set of a query in a specific order. In TiDB, the operator implementing sort is <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/sort.go#L36"><code>SortExec</code></a>. The fundamental concept behind <code>SortExec</code> is to read all the data from its child executor and then sort the entire data set.</p>
<p>In <code>Next</code>, it invokes <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/sort.go#L179"><code>fetchRowChunks</code></a> to read all the data from its child executor. <code>fetchRowChunks</code> aims to store all the data in one <a href="https://github.com/pingcap/tidb/blob/v7.4.0/util/chunk/row_container.go#L460"><code>SortedRowContainer</code></a>. The memory usage grows as the input data volume increases. To manage the memory usage, <code>SortExec</code> has spill-to-disk support. The details of this spilling are encapsulated within <code>SortedRowContainer</code>. Every time the insertion of a chunk into the current <code>SortedRowContainer</code> returns <code>ErrCannotAddBecauseSorted</code>, it indicates that the current <code>SortedRowContainer</code> has been spilled. <code>SortExec</code> will then create a new <code>SortedRowContainer</code> and insert the chunk into this new container. Once there's no data coming from its child executor, <code>SortExec</code> will <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/sort.go#L241">sort</a> the current <code>SortedRowContainer</code>.</p>
<p>After <code>fetchRowChunks</code> completes, <code>Next</code> starts producing sorted results. Depending on whether a spill to disk was initiated, there are two methods to produce the final sorted outcomes:</p>
<ul>
<li>Spill not initiated: In this straightforward scenario, if there's no spill, since the entire <code>SortedRowContainer</code> gets sorted at the end of <code>fetchRowChunks</code>, during <code>Next</code>, it simply invokes <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/sort.go#L133"><code>GetSortedRowAndAlwaysAppendToChunk</code></a> to fetch the sorted data from <code>SortedRowContainer</code>.</li>
<li>Spill initiated: When a spill occurs, each spilling round produces an independent <code>SortedRowContainer</code>, stored in <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/sort.go#L55"><code>partitionList</code></a>. In <code>Next</code>, an <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/sort.go#L143">external multi-way merge sort</a> merges all partially sorted data streams into one final sorted data stream.</li>
</ul>
<h3 id="hashagg"><a class="header" href="#hashagg">HashAgg</a></h3>
<p>The <code>HashAgg</code> operator uses a hash table to perform grouping and aggregation. In TiDB, the operator implementing hash aggregation is <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/aggregate/agg_hash_executor.go#L91"><code>HashAggExec</code></a>.</p>
<p><code>HashAgg</code> has two execution modes: parallel and non-parallel execution. During the build stage, the planner is responsible for deciding the execution mode for a <code>HashAgg</code>. A <code>HashAgg</code> will operate in non-parallel execution mode if one of the following conditions is true:</p>
<ul>
<li>The aggregation function contains <code>distinct</code>.</li>
<li>The aggregation function (<code>GROUP_CONCAT</code>) contains <code>order by</code>.</li>
<li>The user explicitly sets both <code>hashAggPartialConcurrency</code> and <code>hashAggFinalConcurrency</code> to 1.</li>
</ul>
<h4 id="non-parallel-execution"><a class="header" href="#non-parallel-execution">Non-parallel Execution</a></h4>
<p>Non-parallel execution mode performs aggregation in a single thread. <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/aggregate/agg_hash_executor.go#L493"><code>unparallelExec</code></a> is the core function for non-parallel execution. In <code>unparallelExec</code>, it first reads all the data from its child executor, then aggregates the data using <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/aggregate/agg_hash_executor.go#L548">execute</a>. After <code>execute</code> completes, <code>unparallelExec</code> starts to generate results by traversing all the group-by keys, generating one row for each key by calling <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/aggregate/agg_hash_executor.go#L505">AppendFinalResult2Chunk</a> for each aggregation function.</p>
<h4 id="parallel-execution"><a class="header" href="#parallel-execution">Parallel Execution</a></h4>
<p>Parallel execution mode performs aggregation using multiple threads, dividing the aggregation into two stages:</p>
<ul>
<li>Partial stage: each thread aggregates a portion of the input data into partial results.</li>
<li>Final stage: each thread aggregates the partial results into final results.</li>
</ul>
<p>The flow of parallel execution is illustrated in the following graph:</p>
<pre><code>                            +-------------+
                            | Main Thread |
                            +------+------+
                                   ^
                                   |
                                   +
                              +-+-            +-+
                              | |    ......   | |  finalOutputCh
                              +++-            +-+
                               ^
                               |
                               +---------------+
                               |               |
                 +--------------+             +--------------+
                 | final worker |     ......  | final worker |
                 +------------+-+             +-+------------+
                              ^                 ^
                              |                 |
                             +-+  +-+  ......  +-+
                             | |  | |          | |
                             ...  ...          ...    partialOutputChs
                             | |  | |          | |
                             +++  +++          +++
                              ^    ^            ^
          +-+                 |    |            |
          | |        +--------o----+            |
 inputCh  +-+        |        +-----------------+---+
          | |        |                              |
          ...    +---+------------+            +----+-----------+
          | |    | partial worker |   ......   | partial worker |
          +++    +--------------+-+            +-+--------------+
           |                     ^                ^
           |                     |                |
      +----v---------+          +++ +-+          +++
      | data fetcher | +------&gt; | | | |  ......  | |   partialInputChs
      +--------------+          +-+ +-+          +-+

</code></pre>
<p>There are three types of threads that read data and execute the aggregation:</p>
<ul>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/aggregate/agg_hash_executor.go#L343"><code>fetchChildData</code></a>: This thread's concurrency level is set to 1. It reads data from the child executor and places it into <code>inputCh</code>, serving as the input for each partial worker.</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/aggregate/agg_hash_partial_worker.go#L38"><code>HashAggPartialWorker</code></a>: The concurrency of <code>HashAggPartialWorker</code> is determined by <code>hashAggPartialConcurrency</code>. This worker reads the input data, executes partial aggregation on the data, produces partial results, and sends them to the final worker.</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/aggregate/agg_hash_final_worker.go#L40"><code>HashAggFinalWorker</code></a>: The concurrency of <code>HashAggFinalWorker</code> is set by <code>hashAggFinalConcurrency</code>. This worker reads partial results, produces final results, and sends them to <code>finalOutputCh</code>.</li>
</ul>
<p>Similar to <code>Sort</code>, <code>HashAgg</code> is also a memory-intensive operator. When <code>HashAgg</code> runs in non-parallel execution mode, it supports spill-to-disk functionality (spill-to-disk in parallel execution mode is currently <a href="https://github.com/pingcap/tidb/issues/46631">under development</a>). Unlike <code>Sort</code>, which spills all data to disk, the <code>HashAgg</code> approach is different. In the current implementation, once a <code>HashAgg</code> is flagged for spilling, for all subsequent inputs, if the group-by key of a row already exists in the current hash map, the row will be inserted into the hash map. If not, the row gets spilled to disk. Detailed workings of the <code>HashAgg</code> spill can be explored <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/aggregate/agg_hash_executor.go#L587">here</a>.</p>
<h3 id="hashjoin"><a class="header" href="#hashjoin">HashJoin</a></h3>
<p>The <code>HashJoin</code> operator uses a hash table to perform the join operation. In TiDB, the operator that implements hash join is <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/join.go#L121"><code>HashJoinExec</code></a>.</p>
<p><code>HashJoin</code> constructs the results in two distinct stages:</p>
<ol>
<li>Fetch data from the build side child and build a hash table.</li>
<li>Fetch data from the probe side child and probe the hash table using multiple join workers.</li>
</ol>
<h4 id="build-stage"><a class="header" href="#build-stage">Build stage</a></h4>
<p>The <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/join.go#L1168">fetchAndBuildHashTable</a> function orchestrates the build stage. Two threads are engaged in this work:</p>
<ul>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/join.go#L1182">fetchBuildSideRows</a> reads data from the build side child and funnels it into the <code>buildSideResultCh</code>.</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/join.go#L1193">buildHashTableForList</a> retrieves input data from <code>buildSideResultCh</code> and subsequently constructs the hash table based on this input.</li>
</ul>
<p>Detailed mechanics of building the hash table are encapsulated within the <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/hash_table.go#L102"><code>hashRowContainer</code></a>. It's worth noting that, as of now, TiDB does not support the parallel building of hash tables.</p>
<h4 id="probe-stage"><a class="header" href="#probe-stage">Probe stage</a></h4>
<p>The <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/join.go#L390"><code>fetchAndProbeHashTable</code></a> function executes the probe stage. This stage engages two types of threads:</p>
<ul>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/join.go#L235"><code>fetchProbeSideChunks</code></a> operates with a concurrency of 1. It reads data from the probe child and dispatches them to various probe workers.</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/join.go#L88"><code>probeWorker</code></a> instances read data from <code>fetchProbeSideChunks</code> and probe concurrently. The concurrency level is determined by <code>ExecutorConcurrency</code>.</li>
</ul>
<p>Each <code>probeWorker</code> contains a <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/joiner.go#L62"><code>joiner</code></a>, a core data structure implementing various join semantics. Every type of join in TiDB has its specialized joiner. The currently supported joiners include:</p>
<ul>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/joiner.go#L959"><code>innerJoiner</code></a> - For inner join</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/joiner.go#L805"><code>leftOuterJoiner</code></a> - For left outer join</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/joiner.go#L884"><code>rightOuterJoiner</code></a> - For right outer join</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/joiner.go#L364"><code>semiJoiner</code></a> - For semi join</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/joiner.go#L497"><code>antiSemiJoiner</code></a> - For anti semi join</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/joiner.go#L720"><code>antiLeftOuterSemiJoiner</code></a> - For anti left outer semi join</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/joiner.go#L566"><code>leftOuterSemiJoiner</code></a> - For left outer semi join</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/joiner.go#L450"><code>nullAwareAntiSemiJoiner</code></a> - For null aware anti semi join</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/joiner.go#L648"><code>nullAwareAntiLeftOuterSemiJoiner</code></a> - For null aware anti left outer semi join</li>
</ul>
<p>The <code>joiner</code> offers three foundational interfaces:</p>
<ul>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/joiner.go#L75"><code>tryToMatchInners</code></a> - For each row from the probe side, it attempts to match the rows from the build side. Returns true if a match occurs and sets <code>isNull</code> for the special join types: <code>AntiSemiJoin</code>, <code>LeftOuterSemiJoin</code>, and <code>AntiLeftOuterSemiJoin</code>.</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/joiner.go#L80"><code>tryToMatchOuters</code></a> - Exclusive to outer join scenarios where the outer side acts as the build hash table. For each row from the probe (inner) side, it attempts to match the rows from the build (outer) side.</li>
<li><a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/joiner.go#L107"><code>onMissMatch</code></a> - Used in semi join scenarios to manage cases where no rows from the build side match the probe row.</li>
</ul>
<p>During the <code>probeWorker</code> operation, it reads data from the probe side. For every probe row, it attempts to match against the hash table and saves the result into a result chunk. Most of these operations utilize the <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/join.go#L977"><code>join2Chunk</code></a> function for probing. However, for outer joins that use the outer side as the build side, the function <a href="https://github.com/pingcap/tidb/blob/v7.4.0/executor/join.go#L1076"><code>join2ChunkForOuterHashJoin</code></a> is called upon.</p>
<p>Within <code>join2Chunk/join2ChunkForOuterHashJoin</code>, the probe work consists of three steps for each probe row:</p>
<ol>
<li>Quick tests are conducted before accessing the hash table to determine if a probe row won't find a match. For instance, in an inner join, if the join key contains null, the probe can bypass the hash table probing since null will never match any value. For rows that are non-matching, the <code>onMissMatch</code> function is invoked.</li>
<li>The hash table is looked up to identify potential matching rows.</li>
<li>In the absence of potential matching rows, the <code>onMissMatch</code> function is invoked. Otherwise, the <code>tryToMatch</code> function is executed.</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../understand-tidb/memory-management-mechanism.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../understand-tidb/transaction.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../understand-tidb/memory-management-mechanism.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../understand-tidb/transaction.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
